#### **1. 核心架构组件**

- **客户端库**：嵌入客户端程序，缓存 tablet 位置信息，直接与 tablet 服务器通信（不经过 master）。
- **Master 服务器**：管理 tablet 分配、负载均衡、垃圾回收、schema 变更（如创建表/列族），并通过 Chubby 确保单实例活性。
- **Tablet 服务器**：管理多个 tablet（10-1000 个/服务器），处理读写请求，负责 tablet 分裂与合并。

#### **2. Tablet 管理**

- **Tablet 定义**：表的行范围分区，是数据分布和负载均衡的基本单位（默认 100-200MB）。
- **位置查找**：三级 B+树结构
    1. Chubby 文件存储 root tablet 位置；
    2. root tablet 存储 METADATA 表的 tablet 位置；
    3. METADATA 表存储用户数据 tablet 位置。
- **分配机制**：Master 通过 Chubby 监控 tablet 服务器存活状态，未分配的 tablet 由 Master 分配给空闲服务器。

#### **3. 数据存储与读写流程**

- **持久化存储**：依赖 GFS 存储 SSTable（不可变有序键值对文件）和提交日志。
- **写操作**：
    1. 检查权限后写入提交日志（按服务器合并日志以优化 GFS 写入）；
    2. 插入内存中的 memtable（排序缓冲区）。
- **读操作**：
    1. 合并 memtable 和所有 SSTable 的数据视图；
    2. 利用 Bloom 过滤器减少 SSTable 磁盘访问，Block Cache 和 Scan Cache 加速读取。
- **Compaction 机制**：
    - **Minor Compaction**：memtable 达到阈值后冻结并转存为 SSTable；
    - **Major Compaction**：合并多个 SSTable 为一个，删除过期数据，提升读取效率。

#### **4. 优化机制**

- **Locality Groups**：列族分组存储，支持按组压缩和内存策略（如频繁访问的列族加载到内存）。
- **压缩**：两级压缩（Bentley-McIlroy 算法+快速小窗口压缩），针对同一主机数据实现高压缩比（如 Web 页面 10:1）。
- **Bloom 过滤器**：减少不存在行/列的磁盘查询，降低 IO 开销。
- **提交日志优化**：单服务器共享日志文件，通过分组提交（group commit）提升吞吐量，恢复时按 tablet 排序日志条目。

#### **5. 高可用与一致性**

- **Chubby 依赖**：用于分布式锁、Master 选举、tablet 服务器存活检测、元数据存储（如访问控制列表）。
- **故障恢复**：
    - Tablet 服务器故障时，Master 通过 Chubby 检测并重新分配 tablet；
    - Master 故障不影响现有 tablet 分配，新 Master 启动后通过 Chubby 锁和 METADATA 表恢复状态。

#### **6. 性能优化**

- **数据局部性**：行键设计（如反转 URL）使相关数据聚集，减少跨服务器访问；
- **内存管理**：列族可配置为内存存储，避免磁盘 IO；
- **负载均衡**：Master 动态迁移 tablet 以平衡服务器负载，迁移前执行 minor compaction 减少恢复时间。

#### **7. 依赖基础设施**

- **GFS**：存储 SSTable 和提交日志；
- **Chubby**：提供分布式锁和一致性协调；
- **SSTable**：内部存储格式，支持快速查找和范围扫描；
- **集群管理系统**：调度任务、管理资源和机器故障。

#### **关键特性**

- **稀疏多维排序映射**：支持行键、列键、时间戳三维索引；
- **动态扩展性**：通过增加服务器线性扩展存储和吞吐量；
- **多版本控制**：按时间戳保留数据版本，支持自动过期策略。

以上实现细节使 Bigtable 能够支持 PB 级数据、 thousands 台服务器的规模，并满足高吞吐和低延迟需求。